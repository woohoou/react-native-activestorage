var e=require("rn-fetch-blob"),r=require("abab"),t=require("react");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=n(e),a=n(t),s=function(e){var t=e.path;try{return Promise.resolve(o.default.fs.hash(t,"md5")).then(function(e){var t=e.replace(/\r|\n/g,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ").map(function(e){return parseInt(e)}),n=String.fromCharCode.apply(String,t);return r.btoa(n)})}catch(e){return Promise.reject(e)}};function u(){return(u=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}var i=0,c=function(e){var r,t=e.directUploadsUrl,n=e.file,a=e.headers,c=e.onStatusChange,l=++i,d=!1,h=function(){r&&(d=!0,r.cancel())},f=function(e){c(u({},e,{id:l,cancel:h,file:n}))};return f({status:"waiting"}),new Promise(function(e,i){try{return Promise.resolve(function(c,l){try{var h=Promise.resolve(function(e){var r=e.directUploadsUrl,t=e.file,n=e.headers,o=void 0===n?{}:n;try{return Promise.resolve(s({path:t.path})).then(function(e){if(!e)throw new Error("Failed to get file checksum. Path: "+t.path);var n={filename:t.name,content_type:t.type||"image/jpeg",byte_size:t.size,checksum:e};return t.metadata&&(n.metadata=t.metadata),Promise.resolve(fetch(r,{method:"POST",body:JSON.stringify({blob:n}),headers:u({"Content-Type":"application/json"},o)})).then(function(e){return e.json()})})}catch(e){return Promise.reject(e)}}({directUploadsUrl:t,file:n,headers:a})).then(function(t){var a=t.direct_upload,s=a.url,u=a.headers,c=o.default.wrap(n.path);(r=o.default.fetch("PUT",s,u,c)).uploadProgress({interval:250},function(e,r){f({status:"uploading",progress:e/r*100,totalBytes:r,uploadedBytes:e})}).then(function(r){var n=r.info().status;if(n>=200&&n<400)f({status:"success"}),e(t.signed_id);else{var o=new Error("Response not success");f({status:"error",error:o}),i(o)}}).catch(function(e){f(d?{status:"canceled"}:{status:"error",error:e}),i(e)})})}catch(e){return l(e)}return h&&h.then?h.then(void 0,l):h}(0,function(e){return f({status:"error",error:e}),i(e)}))}catch(e){return Promise.reject(e)}})},l=t.createContext({host:"http://localhost:3000",mountPath:"/rails/active_storage",headers:{}}),d=l.Provider,h=function(e){var r,n,o=void 0===e?{}:e,a=o.onSuccess,s=o.onError,i=u({},r=t.useContext(l),{mountPath:n=r.mountPath||"/rails/active_storage",directUploadsUrl:""+r.host+n+"/direct_uploads"}),d=i.directUploadsUrl,h=i.headers,f=t.useState([]),p=f[0],v=f[1],m=t.useCallback(function(e){v(function(r){return function(e,r,t){void 0===t&&(t="id");var n=[].concat(e),o=n.findIndex(function(e){return e[t]===r[t]});return o>=0?n[o]=r:n.push(r),n}(r,e)})},[]),g=t.useCallback(function(e){try{return Promise.resolve(function(r,t){try{var n=Promise.resolve(Promise.all(e.map(function(e){return c({file:e,directUploadsUrl:d,headers:h,onStatusChange:m})}))).then(function(e){var r=e.filter(function(e){return!!e});return r.length>0&&a&&a({signedIds:r}),{signedIds:r}})}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}(0,function(e){return s&&s(e),{}}))}catch(e){return Promise.reject(e)}},[d,h,m,a,s]),P=t.useMemo(function(){return p.some(function(e){return"uploading"===e.status})},[p]);return{upload:g,uploads:p,uploading:P}};exports.ActiveStorageProvider=function(e){return a.default.createElement(d,{value:{host:e.host,mountPath:e.mountPath,headers:e.headers}},e.children)},exports.DirectUpload=function(e){return(0,e.children)(h({onSuccess:e.onSuccess,onError:e.onError}))},exports.checksum=s,exports.directUpload=c,exports.useDirectUpload=h;
//# sourceMappingURL=react-native-activestorage.js.map
