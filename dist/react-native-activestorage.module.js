import r from"rn-fetch-blob";import{btoa as e}from"abab";import t,{createContext as n,useContext as o,useState as a,useCallback as s,useMemo as i}from"react";var u=function(t){var n=t.path;try{return Promise.resolve(r.fs.hash(n,"md5")).then(function(r){var t=r.replace(/\r|\n/g,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ").map(function(r){return parseInt(r)}),n=String.fromCharCode.apply(String,t);return e(n)})}catch(r){return Promise.reject(r)}};function c(){return(c=Object.assign||function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r}).apply(this,arguments)}var l=0,h=function(e){var t,n=e.directUploadsUrl,o=e.file,a=e.headers,s=e.onStatusChange,i=++l,h=!1,d=function(){t&&(h=!0,t.cancel())},f=function(r){s(c({},r,{id:i,cancel:d,file:o}))};return f({status:"waiting"}),new Promise(function(e,s){try{return Promise.resolve(function(i,l){try{var d=Promise.resolve(function(r){var e=r.directUploadsUrl,t=r.file,n=r.headers,o=void 0===n?{}:n;try{return Promise.resolve(u({path:t.path})).then(function(r){if(!r)throw new Error("Failed to get file checksum. Path: "+t.path);var n={filename:t.name,content_type:t.type||"image/jpeg",byte_size:t.size,checksum:r};return t.metadata&&(n.metadata=t.metadata),Promise.resolve(fetch(e,{method:"POST",body:JSON.stringify({blob:n}),headers:c({"Content-Type":"application/json"},o)})).then(function(r){return r.json()})})}catch(r){return Promise.reject(r)}}({directUploadsUrl:n,file:o,headers:a})).then(function(n){var a=n.direct_upload,i=a.url,u=a.headers,c=r.wrap(o.path);(t=r.fetch("PUT",i,u,c)).uploadProgress({interval:250},function(r,e){f({status:"uploading",progress:r/e*100,totalBytes:e,uploadedBytes:r})}).then(function(r){var t=r.info().status;if(t>=200&&t<400)f({status:"success"}),e(n.signed_id);else{var o=new Error("Response not success");f({status:"error",error:o}),s(o)}}).catch(function(r){f(h?{status:"canceled"}:{status:"error",error:r}),s(r)})})}catch(r){return l(r)}return d&&d.then?d.then(void 0,l):d}(0,function(r){return f({status:"error",error:r}),s(r)}))}catch(r){return Promise.reject(r)}})},d=n({host:"http://localhost:3000",mountPath:"/rails/active_storage",headers:{}}),f=d.Provider,p=function(r){return t.createElement(f,{value:{host:r.host,mountPath:r.mountPath,headers:r.headers}},r.children)},m=function(r){var e,t,n=void 0===r?{}:r,u=n.onSuccess,l=n.onError,f=c({},e=o(d),{mountPath:t=e.mountPath||"/rails/active_storage",directUploadsUrl:""+e.host+t+"/direct_uploads"}),p=f.directUploadsUrl,m=f.headers,v=a([]),g=v[0],P=v[1],y=s(function(r){P(function(e){return function(r,e,t){void 0===t&&(t="id");var n=[].concat(r),o=n.findIndex(function(r){return r[t]===e[t]});return o>=0?n[o]=e:n.push(e),n}(e,r)})},[]),U=s(function(r){try{return Promise.resolve(function(e,t){try{var n=Promise.resolve(Promise.all(r.map(function(r){return h({file:r,directUploadsUrl:p,headers:m,onStatusChange:y})}))).then(function(r){var e=r.filter(function(r){return!!r});return e.length>0&&u&&u({signedIds:e}),{signedIds:e}})}catch(r){return t(r)}return n&&n.then?n.then(void 0,t):n}(0,function(r){return l&&l(r),{}}))}catch(r){return Promise.reject(r)}},[p,m,y,u,l]),b=i(function(){return g.some(function(r){return"uploading"===r.status})},[g]);return{upload:U,uploads:g,uploading:b}},v=function(r){return(0,r.children)(m({onSuccess:r.onSuccess,onError:r.onError}))};export{p as ActiveStorageProvider,v as DirectUpload,u as checksum,h as directUpload,m as useDirectUpload};
//# sourceMappingURL=react-native-activestorage.module.js.map
